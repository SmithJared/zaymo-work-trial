# Implementation Plan: URL Shortener Microservice (Go + Supabase)

**Generated by ChatGPT**
**Reviewed/Modified by Jared Smith**

This document outlines how to implement a minimal URL shortening service using **Go**, **Supabase (Postgres)**, and **Base62 encoding**.

---

## 1. Overview

The service will:
- Accept **one or many long URLs** via an HTTP endpoint.
- Insert them into a **Supabase Postgres** table.
- Retrieve the generated IDs from Supabase.
- Encode the IDs into **Base62 short codes**.
- Return a list of short URLs in the API response.
- Redirect users when they visit a short code.

---

## 2. Database Schema (Supabase)

Run this SQL in the Supabase SQL editor:

```sql
create table urls (
  id bigint generated always as identity primary key,
  long_url text not null,
  created_at timestamp with time zone default now()
);
```

id: used as the source for short codes.
long_url: original long URL.
created_at: timestamp of creation.

## 3. Go Dependencies

Add these dependencies to go.mod:

```golang
go get github.com/supabase-community/supabase-go
go get github.com/jxskiss/base62
go get github.com/labstack/echo/v4
```

Also use the echo framework for the server

## 4. HTTP API Design

**POST /shorten**

* Input (JSON):

```json
{
  "urls": [
    "https://example.com/alpha",
    "https://example.com/beta"
  ]
}
```

* Output (JSON);

```json
{
  "shortened": [
    { "id": 1, "long_url": "https://example.com/alpha", "short_url": "http://localhost:8080/1" },
    { "id": 2, "long_url": "https://example.com/beta", "short_url": "http://localhost:8080/2" }
  ]
}
```

**GET /{shortCode}**

* Look up shortCode (Base62 -> id).
* Query Supabase for long_url
* Redirect with HTTP 301.

## 5. Core Logic Flow

**Insert & Encode**
[1.] Receive JSON array of URLs
[2.] Insert into Supabase in a batch insert.
[3.] Supabase returns inserted rows with ids.
[4.] Convert each id → Base62 short code.
[5.] Return JSON with short_urls.

**Redirect**
[1.] Parse short code from URL path.
[2.] Decode Base62 → numeric id.
[3.] Query Supabase for the matching long URL.
[4.] If found → issue HTTP 301 redirect.
[5.] If not found → return 404.a

## 6. Pseudocode Sketch

```golang
func shortenHandler(w http.ResponseWriter, r *http.Request) {
    // Parse JSON body { "urls": [] }
    // Insert into Supabase with Insert([]map[string]interface{})
    // Supabase returns rows with IDs
    // Encode IDs -> Base62
    // Return JSON { short_url: ... }
}

func redirectHandler(w http.ResponseWriter, r *http.Request) {
    // Extract {shortCode} from path
    // Decode Base62 -> id
    // Query Supabase for long_url
    // Redirect (301) or return 404
}
```

## 7. Environment Setup

* Environment variables:
* * SUPABASE_URL = your Supabase project URL
* * SUPABASE_KEY = your Supabase anon/service key

## 8. Future Enhancements

* When urls are batch added to the supabase give them a batch id. When a url is redirected, grab all the batched urls and store them in memory so later url redirects don't need to hit the db
* Add click tracking (click_count column).
* Add expiry dates (expires_at column).
* Add analytics (IP, user agent, referrer).